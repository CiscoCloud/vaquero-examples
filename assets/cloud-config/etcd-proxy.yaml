#cloud-config
coreos:
  update:
    group: stable
    reboot-strategy: off

  etcd2:
    proxy: on
    # cluster endpoints
    listen-client-urls: http://0.0.0.0:2379
    initial-cluster: etcd-n1=http://<%= @host.params['etcd-n1'] %>:2380,etcd-n2=http://<%= @host.params['etcd-n2'] %>:2380,etcd-n3=http://<%= @host.params['etcd-n3'] -%>:2380

  fleet:
    metadata: "role=<%= @role %>,vlan=<%= @host.primary_interface.vlanid %>"

  units:
    - name: down-interfaces.service
      command: start
      content: |
        [Service]
        Type=oneshot
        ExecStart=/usr/bin/ip link set <%= @host.interfaces.first.identifier  %> down
        ExecStart=/usr/bin/ip addr flush dev <%= @host.interfaces.first.identifier  %>
        ExecStart=/usr/bin/ip link set <%= @host.interfaces.second.identifier %> down
        ExecStart=/usr/bin/ip addr flush dev <%= @host.interfaces.second.identifier %>
    - name: systemd-networkd.service
      command: restart
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
      

{{ if index .env "ssh_authorized_keys" }}
ssh_authorized_keys:
  {{ range $element := .env.ssh_authorized_keys }}
  - {{$element}}
  {{end}}
{{end}}

write_files:
  - path: /etc/systemd/network/po0.netdev
    permissions: 0644
    owner: root
    content: |
      [NetDev]
      Name=po0
      Kind=bond

      [Bond]
      Mode=802.3ad
      TransmitHashPolicy=layer3+4
      LACPTransmitRate=fast
      MIIMonitorSec=1
  - path: /etc/systemd/network/po0.network
    permissions: 0644
    owner: root
    content: |
      [Match]
      Name=po0

      [Link]
      MACAddress=<%= @host.interfaces.first.mac %>

      [Network]
      DHCP=ipv4
      BindCarrier=<%= @host.interfaces.first.identifier  %> <%= @host.interfaces.second.identifier %>
  - path: /etc/systemd/network/<%= @host.interfaces.first.identifier  %>.network
    permissions: 0644
    owner: root
    content: |
      [Match]
      Name=<%= @host.interfaces.first.identifier  %>

      [Network]
      Bond=po0
  - path: /etc/systemd/network/<%= @host.interfaces.second.identifier %>.network
    permissions: 0644
    owner: root
    content: |
      [Match]
      Name=<%= @host.interfaces.second.identifier %>
      
      [Network]
      Bond=po0
